<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Dipper Finder</title>
  <style> 
    body {
      font-family: system-ui, sans-serif;
      margin: 20px;
      background: #f8f8f8;
      color: #333;
      text-align: center;
    }
    h1 { color: #2a4d69; }
    .section {
      margin: 1em auto;
      padding: 1em;
      background: white;
      border-radius: 10px;
      box-shadow: 0 2px 6px rgba(0,0,0,0.1);
      max-width: 600px;
    }
    button.color {
      border: none;
      margin: 3px;
      padding: 8px 12px;
      border-radius: 8px;
      cursor: pointer;
      color: white;
      font-weight: bold;
    }
    button.color.selected { outline: 3px solid #000; }

    /* Individual button colors */
    .alu { background: gray; }
    .red { background: red; }
    .yellow { background: goldenrod; color: black; }
    .green { background: green; }
    .blue { background: steelblue; }
    .black { background: black; }
    .white {
      background: white;
      color: black;           /* ensures text is visible */
      border: 1px solid #999;/* border makes button visible */
      font-weight: bold;
    }
    .violet { background: purple; }
    .pink { background: hotpink; color: black; }


	button.color.white {
  		background: white !important;
  		color: black !important;       /* ensures text is visible */
  		border: 1px solid #999;        /* visible border */
  		font-weight: bold;
	}


    .bird-img {
      width: 35px;
      height: 35px;
      vertical-align: middle;
      object-fit: contain;
    }


    #results {
      text-align: left;
      margin-top: 10px;
    }

    /* Table styling */
    #results table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 10px;
    }
    #results th, #results td {
      border-bottom: 1px solid #ccc;
      text-align: left;
      padding: 4px 8px;
    }
    #results th {
      background: #eef;
    }
  </style>
</head>
<body>
  <h1><img src="Johann.png" class="bird-img" alt="icon" /> Dipper Finder</h1>
  
  <div class="section">
    <h2>Right Leg</h2>
    <div id="rightButtons"></div>
  </div>
  
  <div class="section">
    <h2>Left Leg</h2>
    <div id="leftButtons"></div>
  </div>
  
  <div>
    <button id="resetBtn">Reset</button>
  </div>
  
  <div id="results">Automatically loading <b>view_birdsCSV_apps.csv</b>...</div>

  <script>
    const colorMap = {
      "alu": {name: "alu", color: "gray", bg: "transparent"},
      "red": {name: "red", color: "red", bg: "transparent"},
      "yellow": {name: "yellow", color: "goldenrod", bg: "transparent"},
      "green": {name: "green", color: "green", bg: "transparent"},
      "blue": {name: "blue", color: "steelblue", bg: "transparent"},
      "black": {name: "black", color: "black", bg: "transparent"},
      "white": {name: "white", color: "black", bg: "#eee"}, // visible on white background
      "violet": {name: "violet", color: "purple", bg: "transparent"},
      "pink": {name: "pink", color: "hotpink", bg: "transparent"}
    };

    const colors=["alu","red","yellow","green","blue","black","white","violet","pink"];
    const leftSel=new Set(), rightSel=new Set();
    let birds=[];
    const res=document.getElementById("results");

    function short(c){
      if(!c) return "";
      c = c.toLowerCase();
      return c === "metal" ? "alu" : c;
    }

    function makeButtons(side,container){
      colors.forEach(c=>{
        const b=document.createElement("button");
        b.textContent=c;
        b.className="color "+c;
        b.onclick=()=>{toggleSelect(side,c,b);filter();};
        container.appendChild(b);
      });
    }

    function toggleSelect(side,color,btn){
      const set=side==="L"?leftSel:rightSel;
      if(set.has(color)){set.delete(color); btn.classList.remove("selected");}
      else if(set.size<2){set.add(color); btn.classList.add("selected");}
      else{alert("Max 2 colors per leg");}
    }

    function parseCSV(text){
      const lines=text.trim().split(/\r?\n/);
      const headers=lines[0].split(",").map(h=>h.replace(/"/g,'').trim().toLowerCase());
      const gi=h=>headers.indexOf(h);

      const iRt=gi("r_top"), iRb=gi("r_bottom"), iLt=gi("l_top"), iLb=gi("l_bottom"),
            iName=gi("name"), iTerr=gi("territory"), iDist=gi("dist punt dal gal (m)");

      return lines.slice(1).map(row=>{
        const cols = [];
        row.match(/(".*?"|[^",\s]+)(?=\s*,|\s*$)/g)?.forEach(x=>{
          cols.push(x.replace(/^"|"$/g,'').trim());
        });
        return {
          Rt:(cols[iRt]||"").toLowerCase(),
          Rb:(cols[iRb]||"").toLowerCase(),
          Lt:(cols[iLt]||"").toLowerCase(),
          Lb:(cols[iLb]||"").toLowerCase(),
          name:(cols[iName]||"").replace(/null/i,""),
          terr:(cols[iTerr]||""),
          dist:(cols[iDist]||"")
        };
      });
    }

    function matches(b){
      const leftOk=[b.Lt,b.Lb].filter(Boolean);
      const rightOk=[b.Rt,b.Rb].filter(Boolean);
      const L=[...leftSel],R=[...rightSel];
      return (!L.length||L.every(x=>leftOk.includes(x))) && (!R.length||R.every(x=>rightOk.includes(x)));
    }

    function colorSpan(code){
      code = short(code);
      if(!code) return "";
      const c = colorMap[code];
      if(!c) return code; // fallback for unknown colors
      return `<span style="color:${c.color}; background:${c.bg}; font-weight:bold; padding:0 2px;">${c.name}</span>`;
    }

    function filter(){
      if(!birds.length) return;
      const m = birds.filter(matches);

      if(m.length) {
        let html = '<table>';
        html += '<thead><tr>'+
          '<th>Name</th>'+
          '<th>Territory (Dist PdG)</th>'+
          '<th>R↑/R↓ - L↑/L↓</th>'+
          '</tr></thead><tbody>';

        m.forEach(x => {
          html += '<tr>'+
            `<td>${x.name || "Unknown"}</td>`+
            `<td>${x.terr} (${x.dist || ""} m)</td>`+
            `<td>${colorSpan(x.Rt)}/${colorSpan(x.Rb)} - ${colorSpan(x.Lt)}/${colorSpan(x.Lb)}</td>`+
            '</tr>';
        });

        html += '</tbody></table>';
        res.innerHTML = html;
      } else {
        res.innerHTML = "<p>No matches.</p>";
      }
    }

    function resetAll(){
      leftSel.clear(); rightSel.clear(); res.innerHTML="";
      document.querySelectorAll("button.color").forEach(b=>b.classList.remove("selected"));
    }

    document.getElementById("resetBtn").onclick=resetAll;
    makeButtons("R",document.getElementById("rightButtons"));
    makeButtons("L",document.getElementById("leftButtons"));

    // Fetch CSV
    const username = "wdomi"; 
    const repo = "dipper_finder";
    const csvPath = `https://${username}.github.io/${repo}/view_birdsCSV_apps.csv`;

    fetch(csvPath)
      .then(r => {
        if (!r.ok) throw new Error("Could not load CSV (" + r.status + ")");
        return r.text();
      })
      .then(text => {
        birds = parseCSV(text);
        filter();
      })
      .catch(err => {
        res.innerHTML = "<p style='color:red'>⚠️ Failed to load CSV: " + err.message + "</p>";
      });
  </script>
</body>
</html>
