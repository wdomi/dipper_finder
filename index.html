<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Dipper Finder</title>
<style>
  :root{
    --muted:#666;
    --accent:#2a4d69;
    --ok:#4caf50;
    --danger:#d9534f;
  }
  body{
    font-family: system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial;
    margin:0;
    padding:12px;
    background:#f8f8f8;
    color:#222;
  }

  header{
    display:flex;
    flex-direction:column;
    gap:8px;
    margin-bottom:6px;
  }
  h1{
    font-size:24px;
    margin:0;
    display:flex;
    align-items:center;
    gap:8px;
  }
  .bird-img{ width:48px; height:48px; object-fit:contain; }

  .top-actions{ display:flex; gap:12px; align-items:center; }
  .reset-btn{
    background:#e6e6e6;
    border:1px solid #bbb;
    padding:8px 12px;
    border-radius:8px;
    cursor:pointer;
    font-size:14px;
  }

  .section{
    background:white;
    border-radius:10px;
    padding:8px;
    box-shadow:0 1px 4px rgba(0,0,0,0.06);
    margin:8px 0;
  }
  .leg-title{ font-weight:600; margin:6px 4px 4px; font-size:14px; }

  .color-grid{
    display:grid;
    grid-template-columns: repeat(5, 1fr);
    gap:6px;
    padding:4px;
  }
  button.color{
    height:36px;
    border-radius:8px;
    border:1px solid rgba(0,0,0,0.12);
    font-weight:700;
    cursor:pointer;
    color:white;
  }
  .alu{ background:gray; }
  .red{ background:red; }
  .yellow{ background:goldenrod; color:black; }
  .green{ background:green; }
  .blue{ background:steelblue; }
  .black{ background:black; }
  button.color.white{
    background:white !important;
    color:black !important;
    border:1px solid #999;
    font-weight:700;
  }
  .violet{ background:purple; }
  .pink{ background:hotpink; color:black; }

  button.color.selected{ outline:3px solid #000; }

  .submit-area{ margin-top:6px; }
  .submit-btn{
    background:var(--accent);
    color:white;
    padding:10px 14px;
    border-radius:8px;
    border:none;
    cursor:pointer;
    font-size:15px;
    text-align:left;
    display:block;
  }

  #results{ margin-top:10px; text-align:left; }
  table{ width:100%; border-collapse:collapse; font-size:14px; }
  th, td{ padding:8px 6px; border-bottom:1px solid #e6e6e6; vertical-align:middle; }
  th{ background:#f0f6fa; text-align:left; font-weight:600; }
  .small-muted{ color:var(--muted); font-size:12px; }

  .action-group{ display:flex; gap:8px; }
  .toggle-btn{
    padding:6px 10px;
    border-radius:6px;
    border:1px solid #bbb;
    cursor:pointer;
    background:#f4f4f4;
    font-weight:600;
  }
  .toggle-on.sighted{ background:#c8f6d1; border-color:#74c46b; }
  .toggle-on.maybe{ background:#ffe9a3; border-color:#d4a22b; }

  .code-pill{ display:inline-block; padding:2px 6px; border-radius:6px; font-weight:700; margin-right:4px; }

  .toast{
    position:fixed; right:16px; bottom:16px;
    background:rgba(0,0,0,0.8); color:white; padding:10px 12px; border-radius:8px; display:none;
  }
  .toast.show{ display:block; }

  @media (max-width:520px){
    .color-grid{ grid-template-columns: repeat(4, 1fr); }
    th, td{ padding:6px 4px; font-size:13px; }
    h1{ font-size:22px; }
  }

  /* New tweaks */
  td.codes-column, th.codes-column{
    font-size:12px;
    line-height:1.2;
  }
  .action-group.vertical{
    flex-direction: column;
    gap:4px;
  }
  .action-group.vertical .toggle-btn{
    width:100%;
  }
</style>
</head>
<body>

<header>
  <h1><img src="Johann.png" class="bird-img" alt="icon"> Dipper Finder</h1>
  <div class="top-actions">
    <button class="reset-btn" id="resetColorsBtn">Reset</button>
    <div class="small-muted">Select up to 2 colors per leg</div>
  </div>
</header>

<div class="section" aria-labelledby="right-leg">
  <div class="leg-title" id="right-leg">Right Leg</div>
  <div class="color-grid" id="rightButtons"></div>
</div>

<div class="section" aria-labelledby="left-leg">
  <div class="leg-title" id="left-leg">Left Leg</div>
  <div class="color-grid" id="leftButtons"></div>
</div>

<div class="submit-area">
  <button class="submit-btn" id="submitBtn">Submit Sightings</button>
  <div class="small-muted">Your location will be requested when submitting sightings.</div>
</div>

<div id="results">Loading <b>view_birdsCSV_apps.csv</b>…</div>

<div id="toast" class="toast" role="status" aria-live="polite"></div>

<script>
/* ================= CONFIG ================= */
const CSV_URL = "https://wdomi.github.io/dipper_finder/view_birdsCSV_apps.csv";
const BASEROW_ENDPOINT = "https://api.baserow.io/api/database/rows/table/742957/?user_field_names=true";
const BASEROW_TOKEN = "PrcSgbmmUfRH1repX8wmIeixWCGUV4X9";
const ACTION_IDS = { sighted: 4519311, maybe: 4519312 };

const colorButtons = ["alu","red","yellow","green","blue","black","white","violet","pink"];
const colorCodeMap = {
  "yellow": { code:"ylw", color:"goldenrod" },
  "alu":    { code:"alu", color:"gray" },
  "metal":  { code:"alu", color:"gray" },
  "black":  { code:"blk", color:"black" },
  "red":    { code:"red", color:"red" },
  "green":  { code:"grn", color:"green" },
  "violet": { code:"vlt", color:"purple" },
  "pink":   { code:"pnk", color:"hotpink" },
  "blue":   { code:"blu", color:"steelblue" },
  "white":  { code:"wht", color:"white" }
};

function normalizeColorKey(s){
  if(!s) return "";
  s = String(s).toLowerCase().trim();
  if(s === "metal") return "alu";
  if(s.startsWith("yl")) return "yellow";
  if(s.startsWith("alu")) return "alu";
  if(s.startsWith("blk")) return "black";
  if(s.startsWith("red")) return "red";
  if(s.startsWith("gr")) return "green";
  if(s.startsWith("vio")) return "violet";
  if(s.startsWith("pn")) return "pink";
  if(s.startsWith("bl")) return "blue";
  if(s.startsWith("wh")) return "white";
  return s;
}

function codePillFor(raw){
  const key = normalizeColorKey(raw);
  const meta = colorCodeMap[key];
  if(!meta) return `<span class="code-pill">${escapeHtml(raw||"")}</span>`;
  const textColor = (meta.code === "wht") ? "#000" : meta.color;
  const bg = (meta.code === "wht") ? "#eee" : "transparent";
  return `<span class="code-pill" style="color:${textColor}; background:${bg};">${meta.code}</span>`;
}

/* ================= UI ================ */
const rightButtons = document.getElementById("rightButtons");
const leftButtons = document.getElementById("leftButtons");
const maxPerLeg = 2;
const rightSel = [];
const leftSel = [];

function makeColorButton(name){
  const b = document.createElement("button");
  b.type = "button";
  b.className = "color " + name;
  b.textContent = name;
  if(name === "white") b.classList.add("white");
  return b;
}

colorButtons.forEach(c=>{
  const br = makeColorButton(c);
  br.addEventListener("click", ()=>toggleColorSelection("right",c,br));
  rightButtons.appendChild(br);
  const bl = makeColorButton(c);
  bl.addEventListener("click", ()=>toggleColorSelection("left",c,bl));
  leftButtons.appendChild(bl);
});

function toggleColorSelection(side,color,btn){
  const arr = side==="right"?rightSel:leftSel;
  const idx = arr.indexOf(color);
  if(idx>=0){ arr.splice(idx,1); btn.classList.remove("selected"); }
  else if(arr.length<maxPerLeg){ arr.push(color); btn.classList.add("selected"); }
  renderFilteredTable();
}

document.getElementById("resetColorsBtn").addEventListener("click", ()=>{
  rightSel.splice(0); leftSel.splice(0);
  document.querySelectorAll("button.color").forEach(b=>b.classList.remove("selected"));
  renderFilteredTable();
});

/* ================= CSV parsing =============== */
let birds=[];
const resultsEl = document.getElementById("results");

function parseCSV(text){
  const lines = text.trim().split(/\r?\n/);
  if(lines.length===0) return [];
  const headers = lines[0].split(",").map(h=>h.replace(/"/g,'').trim().toLowerCase());
  const gi = key=>headers.indexOf(key);

  const i_bird_id = gi("bird_id"), i_name=gi("name"), i_sex=gi("sex"),
        i_age=gi("age"), i_r_top=gi("r_top"), i_r_bottom=gi("r_bottom"),
        i_l_top=gi("l_top"), i_l_bottom=gi("l_bottom"),
        i_territory=gi("territory"), i_territory_name=gi("territory_name"),
        i_dist=gi("dist punt dal gal (m)"), i_banded_on=gi("banded_on");

  return lines.slice(1).map(row=>{
    const cols = [];
    row.match(/(".*?"|[^",\s]+)(?=\s*,|\s*$)/g)?.forEach(x=>cols.push(x.replace(/^"|"$/g,'').trim()));
    return {
      bird_id: cols[i_bird_id]||"",
      name: cols[i_name]||"",
      sex: cols[i_sex]||"",
      age: cols[i_age]||"",
      Rt: (cols[i_r_top]||"").toLowerCase(),
      Rb: (cols[i_r_bottom]||"").toLowerCase(),
      Lt: (cols[i_l_top]||"").toLowerCase(),
      Lb: (cols[i_l_bottom]||"").toLowerCase(),
      territory: cols[i_territory]||cols[i_territory_name]||"",
      dist: cols[i_dist]||"",
      banded_on: cols[i_banded_on]||""
    };
  });
}

/* ================= Filtering ================= */
function matchesRow(row){
  const leftOk=[normalizeColorKey(row.Lt),normalizeColorKey(row.Lb)].filter(Boolean);
  const rightOk=[normalizeColorKey(row.Rt),normalizeColorKey(row.Rb)].filter(Boolean);
  const Rsel=rightSel.map(mapButtonToCsvKey).filter(Boolean);
  const Lsel=leftSel.map(mapButtonToCsvKey).filter(Boolean);
  const rightMatch=(Rsel.length===0)||Rsel.every(sel=>rightOk.includes(sel));
  const leftMatch=(Lsel.length===0)||Lsel.every(sel=>leftOk.includes(sel));
  return rightMatch && leftMatch;
}

function mapButtonToCsvKey(btnName){ return btnName; }

const perBirdSelection=new Map();

function escapeHtml(s){ if(s==null)return""; return String(s).replaceAll("&","&amp;").replaceAll("<","&lt;").replaceAll(">","&gt;").replaceAll('"',"&quot;").replaceAll("'","&#39;"); }

/* ================= Render table ================= */
function renderFilteredTable(){
  if(!birds.length){ resultsEl.innerHTML="<p class='small-muted'>No data loaded yet.</p>"; return; }
  const matched = birds.filter(matchesRow);
  if(matched.length===0){ resultsEl.innerHTML="<p class='small-muted'>No matches.</p>"; return; }

  const table=document.createElement("table");
  const thead=document.createElement("thead");
  const trh=document.createElement("tr");
  ["Name (bird_id)","Sex / Age (Banded)","Territory (Dist m)","R↑/↓ - L↑/↓","Actions"].forEach((h,i)=>{
    const th=document.createElement("th");
    th.textContent=h;
    if(i===3) th.classList.add("codes-column");
    trh.appendChild(th);
  });
  thead.appendChild(trh);
  table.appendChild(thead);
  const tbody=document.createElement("tbody");

  matched.forEach(row=>{
    const tr=document.createElement("tr");

    const tdName=document.createElement("td");
    tdName.innerHTML=`${escapeHtml(row.name||"")} <div class="small-muted">(${escapeHtml(row.bird_id||"")})</div>`;
    tr.appendChild(tdName);

    const tdSex=document.createElement("td");
    tdSex.textContent=`${row.sex||""}${row.age?" / "+row.age:""}${row.banded_on?" ("+row.banded_on+")":""}`;
    tr.appendChild(tdSex);

    const tdTerr=document.createElement("td");
    tdTerr.textContent=`${row.territory||""}${row.dist?" ("+row.dist+" m)":""}`;
    tr.appendChild(tdTerr);

    const tdCodes=document.createElement("td");
    tdCodes.classList.add("codes-column");
    tdCodes.innerHTML=`${codePillFor(row.Rt)}/${codePillFor(row.Rb)}-${codePillFor(row.Lt)}/${codePillFor(row.Lb)}`;
    tr.appendChild(tdCodes);

    const tdActions=document.createElement("td");
    const wrap=document.createElement("div");
    wrap.className="action-group vertical";

    const btnSight=document.createElement("button");
    btnSight.type="button"; btnSight.className="toggle-btn sighted"; btnSight.textContent="Sighted";
    const btnMaybe=document.createElement("button");
    btnMaybe.type="button"; btnMaybe.className="toggle-btn maybe"; btnMaybe.textContent="Maybe";

    const cur=perBirdSelection.get(row.bird_id)||null;
    if(cur==="sighted") btnSight.classList.add("toggle-on");
    if(cur==="maybe") btnMaybe.classList.add("toggle-on");

    btnSight.addEventListener("click", ()=>{
      perBirdSelection.set(row.bird_id, perBirdSelection.get(row.bird_id)==="sighted"?null:"sighted");
      renderFilteredTable();
    });
    btnMaybe.addEventListener("click", ()=>{
      perBirdSelection.set(row.bird_id, perBirdSelection.get(row.bird_id)==="maybe"?null:"maybe");
      renderFilteredTable();
    });

    wrap.appendChild(btnSight); wrap.appendChild(btnMaybe);
    tdActions.appendChild(wrap); tr.appendChild(tdActions);
    tbody.appendChild(tr);
  });

  table.appendChild(tbody);
  resultsEl.innerHTML=""; resultsEl.appendChild(table);
}

/* ========== Geolocation request ========== */
async function requestLocation(){
  if(!navigator.geolocation){
    alert("Geolocation is not supported by your browser.");
    return {lat:null, lon:null};
  }
  return new Promise(resolve=>{
    navigator.geolocation.getCurrentPosition(
      pos=>resolve({lat: Number(pos.coords.latitude.toFixed(10)), lon: Number(pos.coords.longitude.toFixed(10))}),
      err=>{
        if(err.code===1) alert("Location denied; coordinates will be empty.");
        else if(err.code===2) alert("Location unavailable; coordinates will be empty.");
        else if(err.code===3) alert("Location timeout; coordinates will be empty.");
        resolve({lat:null, lon:null});
      },
      {timeout:8000}
    );
  });
}

/* ========== Submit sightings ========== */
const submitBtn=document.getElementById("submitBtn");
submitBtn.addEventListener("click", handleSubmitAll);

async function handleSubmitAll(){
  const entries=[];
  for(const [bird_id,val] of perBirdSelection.entries()){
    if(val==="sighted"||val==="maybe"){
      const r=birds.find(b=>b.bird_id===bird_id);
      if(!r) continue;
      entries.push({row:r, action:val});
    }
  }
  if(entries.length===0){ alert("No selected birds to submit."); return; }

  showToast("Getting location...");
  const gps=await requestLocation();

  showToast("Submitting sightings...");
  let successCount=0;
  for(const e of entries){
    const payload={
      "bird_name": e.row.name||"",
      "bird_id": e.row.bird_id||"",
      "action": (e.action==="sighted"?ACTION_IDS.sighted:ACTION_IDS
