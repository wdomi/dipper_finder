<!DOCTYPE html>
<html lang="en">
<head>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Dipper Finder</title>

<style>
    body {
        font-family: sans-serif;
        margin: 0;
        padding: 10px;
        background: #f6f6f6;
    }

    h1 {
        font-size: 26px;
        margin-bottom: 8px;
    }

    .reset-btn {
        margin-bottom: 16px;
        margin-top: 4px;
        padding: 8px 14px;
        background: #ddd;
        border: none;
        border-radius: 6px;
        cursor: pointer;
        font-size: 15px;
    }

    .leg-title {
        margin-top: 6px;
        margin-bottom: 2px; /* reduced whitespace */
        font-weight: bold;
    }

    .color-grid {
        display: grid;
        grid-template-columns: repeat(5, 1fr);
        gap: 6px;
        margin-bottom: 10px;
    }

    .color-button {
        width: 100%;
        height: 38px;
        border-radius: 6px;
        border: 1px solid #aaa;
        font-size: 12px;
        color: #000;
        cursor: pointer;
    }

    .selected {
        outline: 3px solid #000;
    }

    .results {
        margin-top: 8px;
    }

    .bird-entry {
        background: #fff;
        padding: 10px;
        border-radius: 8px;
        margin-bottom: 10px;
        border: 1px solid #ccc;
    }

    .sighting-buttons {
        display: flex;
        gap: 10px;
        margin-top: 6px;
    }

    .sighting-buttons button {
        flex: 1;
        padding: 6px;
        font-size: 14px;
        border-radius: 6px;
        cursor: pointer;
        border: none;
    }

    .sighted {
        background: #b7ffb7;
    }

    .maybe {
        background: #ffe6a8;
    }

    .submit-btn {
        margin-top: 14px;
        padding: 10px 14px;
        background: #4caf50;
        color: white;
        border: none;
        border-radius: 6px;
        cursor: pointer;
        font-size: 16px;
        text-align: left; /* left aligned */
        display: block;
    }

</style>
</head>
<body>

<h1>Dipper Finder</h1>

<button class="reset-btn" onclick="resetAll()">Reset – select up to 2 colors per leg</button>

<div id="color-selectors">
    <div class="leg-title">Right Leg</div>
    <!-- Reduced whitespace -->
    <div class="color-grid" id="right-leg-grid"></div>

    <div class="leg-title">Left Leg</div>
    <!-- Reduced whitespace -->
    <div class="color-grid" id="left-leg-grid"></div>
</div>

<div class="results" id="results"></div>

<button class="submit-btn" onclick="submitSightings()">Submit Sightings</button>

<script>
/* ---------------------------------------------
   COLOR SETUP
--------------------------------------------- */
const colors = [
    { name: "ylw", hex: "#fff700" },
    { name: "alu", hex: "#d9d9d9" },
    { name: "blk", hex: "#000000" },
    { name: "red", hex: "#ff0000" },
    { name: "grn", hex: "#00aa00" },
    { name: "vlt", hex: "#9933ff" },
    { name: "pnk", hex: "#ff82c6" },
    { name: "blu", hex: "#0066ff" },
    { name: "wht", hex: "#ffffff" }
];

/* Render color buttons */
function setupLegGrid(leg) {
    const grid = document.getElementById(`${leg}-leg-grid`);
    colors.forEach(color => {
        const btn = document.createElement("button");
        btn.className = "color-button";
        btn.style.background = color.hex;
        btn.textContent = color.name;
        btn.onclick = () => toggleColor(leg, color.name, btn);
        grid.appendChild(btn);
    });
}

setupLegGrid("right");
setupLegGrid("left");

/* Max 2 per leg */
const selections = { right: [], left: [] };

function toggleColor(leg, color, btn) {
    const arr = selections[leg];

    if (arr.includes(color)) {
        selections[leg] = arr.filter(c => c !== color);
        btn.classList.remove("selected");
    } else {
        if (arr.length >= 2) return;
        arr.push(color);
        btn.classList.add("selected");
    }

    filterBirds();
}

/* ---------------------------------------------
   BIRD DATA (you already have this list)
--------------------------------------------- */

const birds = BIRD_DATA_PLACEHOLDER; 
// I will fill this once you paste your bird list again.

/* Matching logic */
function filterBirds() {
    const res = document.getElementById("results");
    res.innerHTML = "";

    const R_top = selections.right[0] || null;
    const R_bottom = selections.right[1] || null;
    const L_top = selections.left[0] || null;
    const L_bottom = selections.left[1] || null;

    const filtered = birds.filter(bird =>
        (!R_top || bird.R_top === R_top) &&
        (!R_bottom || bird.R_bottom === R_bottom) &&
        (!L_top || bird.L_top === L_top) &&
        (!L_bottom || bird.L_bottom === L_bottom)
    );

    filtered.forEach(bird => {
        const div = document.createElement("div");
        div.className = "bird-entry";
        div.id = `bird-${bird.bird_id}`;

        div.innerHTML = `
            <strong>${bird.name}</strong><br>
            ID: ${bird.bird_id}<br>
            <small>R↑ ${bird.R_top}, R↓ ${bird.R_bottom}, L↑ ${bird.L_top}, L↓ ${bird.L_bottom}</small>

            <div class="sighting-buttons">
                <button class="sighted" onclick="markSighting(${bird.bird_id}, 'sighted')">Sighted</button>
                <button class="maybe" onclick="markSighting(${bird.bird_id}, 'maybe')">Maybe</button>
            </div>
        `;

        res.appendChild(div);
    });
}

/* Exclusive toggle */
const marked = {}; // bird_id → "sighted" or "maybe"

function markSighting(id, state) {
    marked[id] = marked[id] === state ? null : state;
}

/* ---------------------------------------------
   SUBMIT TO BASEROW
--------------------------------------------- */

async function submitSightings() {
    const token = "PrcSgbmmUfRH1repX8wmIeixWCGUV4X9";
    const tableID = 742957;

    if (Object.keys(marked).length === 0) {
        alert("No birds selected."); 
        return;
    }

    /* Get GPS */
    let lat = null, lon = null;
    try {
        const pos = await new Promise((resolve, reject) =>
            navigator.geolocation.getCurrentPosition(resolve, reject)
        );
        lat = pos.coords.latitude;
        lon = pos.coords.longitude;
    } catch {
        alert("Location not available – submitting without GPS.");
    }

    /* Send each marked bird */
    for (const id of Object.keys(marked)) {
        const state = marked[id];
        if (!state) continue;

        const row = birds.find(b => b.bird_id == id);

        const payload = {
            bird_name: row.name,
            bird_id: row.bird_id,
            action: state,
            latitude: lat,
            longitude: lon
        };

        await fetch(`https://api.baserow.io/api/database/rows/table/${tableID}/?user_field_names=true`, {
            method: "POST",
            headers: {
                "Authorization": `Token ${token}`,
                "Content-Type": "application/json"
            },
            body: JSON.stringify(payload)
        });
    }

    alert("Sightings submitted!");

    resetAll();
}

/* ---------------------------------------------
   RESET EVERYTHING
--------------------------------------------- */

function resetAll() {
    selections.right = [];
    selections.left = [];
    marked = {};

    document.querySelectorAll(".color-button").forEach(btn => btn.classList.remove("selected"));
    document.getElementById("results").innerHTML = "";
}

</script>

</body>
</html>
