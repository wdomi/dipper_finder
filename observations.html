<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>Dipper Finder – Recent Observations</title>
<link rel="icon" href="/favicon.png" type="image/png">

<style>
body{
  font-family:system-ui, -apple-system,"Segoe UI",Roboto,Arial;
  margin:0;
  padding:16px;
  background:#111;
  color:#f5f5f5;
}
header{
  display:flex;
  justify-content:space-between;
  align-items:center;
  gap:12px;
  margin-bottom:16px;
  flex-wrap:wrap;
}
h1{
  font-size:22px;
  margin:0;
  display:flex;
  align-items:center;
  gap:8px;
}
.subtitle{
  font-size:13px;
  color:#aaa;
}
.back-btn{
  padding:8px 12px;
  border-radius:999px;
  border:1px solid #555;
  background:#222;
  color:#f5f5f5;
  cursor:pointer;
  font-size:14px;
}
.back-btn:hover{
  background:#333;
}
.card{
  background:#1b1b1b;
  border-radius:10px;
  padding:12px;
  box-shadow:0 1px 4px rgba(0,0,0,0.8);
}
.status{
  font-size:13px;
  margin-bottom:10px;
  color:#bbb;
}
table{
  width:100%;
  border-collapse:collapse;
  font-size:13px;
}
th, td{
  padding:8px 6px;
  border-bottom:1px solid #333;
  vertical-align:middle;
}
th{
  text-align:left;
  background:#181818;
  font-weight:600;
}
.badge{
  display:inline-block;
  padding:2px 8px;
  border-radius:999px;
  font-size:12px;
  font-weight:600;
}
.badge-sighted{
  background:#244f2a;
  color:#c7f5cf;
}
.badge-maybe{
  background:#5a4a21;
  color:#ffe9a3;
}
.small{
  font-size:11px;
  color:#999;
}
@media (max-width:600px){
  table, thead, tbody, th, td, tr{
    display:block;
  }
  thead{ display:none; }
  tr{
    margin-bottom:10px;
    border-bottom:1px solid #333;
    padding-bottom:6px;
  }
  td{ padding:4px 0; }
  td::before{
    content:attr(data-label) ": ";
    font-weight:600;
    display:inline-block;
    width:120px;
    color:#aaa;
  }
}
</style>
</head>
<body>

<header>
  <div>
    <h1>Recent Dipper Observations</h1>
    <div class="subtitle">Most recent first (from Baserow sightings table)</div>
  </div>
  <button class="back-btn" id="backBtn">Back to Dipper Finder</button>
</header>

<div class="card">
  <div id="status" class="status">Loading observations…</div>
  <div id="tableContainer"></div>
</div>

<script>
const ACTION_IDS = { sighted: 4519311, maybe: 4519312 };

function getActionLabel(action) {
  if (action && typeof action === "object") {
    if (action.value) return action.value;
    if (action.id === ACTION_IDS.sighted) return "sighted";
    if (action.id === ACTION_IDS.maybe) return "maybe";
  }
  if (action === ACTION_IDS.sighted) return "sighted";
  if (action === ACTION_IDS.maybe) return "maybe";
  return "";
}

function getActionClass(action) {
  if (action && typeof action === "object") {
    if (action.id === ACTION_IDS.sighted) return "badge badge-sighted";
    if (action.id === ACTION_IDS.maybe) return "badge badge-maybe";
  }
  if (action === ACTION_IDS.sighted) return "badge badge-sighted";
  if (action === ACTION_IDS.maybe) return "badge badge-maybe";
  return "badge";
}

function formatCoord(value) {
  if (value == null || value === "") return "";
  const n = Number(value);
  if (Number.isNaN(n)) return String(value);
  return n.toFixed(5);
}

function formatDate(iso) {
  if (!iso) return "";
  const d = new Date(iso);
  if (Number.isNaN(d.getTime())) return iso;
  const y = d.getFullYear();
  const m = String(d.getMonth()+1).padStart(2,"0");
  const day = String(d.getDate()).padStart(2,"0");
  const hh = String(d.getHours()).padStart(2,"0");
  const mm = String(d.getMinutes()).padStart(2,"0");
  return `${y}-${m}-${day} ${hh}:${mm}`;
}

// Back button → go to root
document.getElementById("backBtn").addEventListener("click", () => {
  window.location.href = "/";
});

const statusEl = document.getElementById("status");
const tableContainer = document.getElementById("tableContainer");

fetch("/api/observations")
  .then(r => {
    if (!r.ok) throw new Error("HTTP " + r.status);
    return r.json();
  })
  .then(data => {
    let rows = data.results || [];

    // map field IDs -> friendly names from Baserow
    rows.forEach(r => {
      r.bird_name = r.field_6258635;
      r.bird_id   = r.field_6258636;
      r.action    = r.field_6258637;
      r.date      = r.field_6258638;
      r.territory = r.field_6258639;
      r.latitude  = r.field_6258640;
      r.longitude = r.field_6318262;
    });

    if (!rows.length) {
      statusEl.textContent = "No observations yet.";
      tableContainer.innerHTML = "";
      return;
    }

    statusEl.textContent = "Showing " + rows.length + " most recent observations.";

    const table = document.createElement("table");

    table.innerHTML = `
      <thead>
        <tr>
          <th>ID</th>
          <th>Bird</th>
          <th>Action</th>
          <th>Date</th>
          <th>Location</th>
        </tr>
      </thead>
    `;

    const tbody = document.createElement("tbody");

    rows.forEach(row => {
      const tr = document.createElement("tr");

      // Row ID
      const idCell = document.createElement("td");
      idCell.setAttribute("data-label", "ID");
      idCell.textContent = row.id ?? "";
      tr.appendChild(idCell);

      // Bird
      const birdCell = document.createElement("td");
      birdCell.setAttribute("data-label", "Bird");
      birdCell.innerHTML = `
        <div>${row.bird_name || "(unnamed)"}</div>
        <div class="small">${row.bird_id ? "(" + row.bird_id + ")" : ""}</div>
      `;
      tr.appendChild(birdCell);

      // Action
      const actionCell = document.createElement("td");
      actionCell.setAttribute("data-label", "Action");
      const cls = getActionClass(row.action);
      const label = getActionLabel(row.action);
      actionCell.innerHTML = label ? `<span class="${cls}">${label}</span>` : "";
      tr.appendChild(actionCell);

      // Date
      const dateCell = document.createElement("td");
      dateCell.setAttribute("data-label", "Date");
      dateCell.textContent = formatDate(row.date);
      tr.appendChild(dateCell);

      // Location
      const locCell = document.createElement("td");
      locCell.setAttribute("data-label", "Location");

      const lat = formatCoord(row.latitude);
      const lon = formatCoord(row.longitude);

if (row.territory && (lat || lon)) {
  locCell.textContent = `${row.territory} – ${lat || "?"}, ${lon || "?"}`;
} else if (row.territory) {
  locCell.textContent = row.territory;
} else if (lat || lon) {
if (lat && lon) {
  locCell.textContent = `${lat.toFixed(5)}, ${lon.toFixed(5)}`;
} else if (lat) {
  locCell.textContent = `${lat.toFixed(5)}`;
} else if (lon) {
  locCell.textContent = `${lon.toFixed(5)}`;
} else {
  locCell.textContent = "No coordinates";
}
} else {
  locCell.textContent = "No coordinates";
}


      tr.appendChild(locCell);

      tbody.appendChild(tr);
    });

    table.appendChild(tbody);
    tableContainer.innerHTML = "";
    tableContainer.appendChild(table);
  })
  .catch(err => {
    console.error("Error loading observations:", err);
    statusEl.textContent = "Failed to load observations.";
    tableContainer.innerHTML = "";
  });
</script>

</body>
</html>
